<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>KMZ HP Match vs Takeout</title>

<!-- JSZIP -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<!-- TURF -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
}
h2 {
  margin-bottom: 10px;
}
input, button {
  margin: 6px 0;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  font-size: 13px;
}
th {
  background: #f0f0f0;
}
.MATCH {
  background: #c8f7c5;
}
.TAKEOUT {
  background: #f7c5c5;
}
</style>
</head>

<body>

<h2>HP MATCH vs TAKEOUT (KMZ)</h2>

<label>KMZ SURVEI (HP Aktual):</label><br>
<input type="file" id="kmzSurvei" accept=".kmz"><br><br>

<label>KMZ DESIGN (Rencana):</label><br>
<input type="file" id="kmzDesign" accept=".kmz"><br><br>

<button id="btnProses">PROSES</button>

<p id="info"></p>

<table>
<thead>
<tr>
  <th>No</th>
  <th>ID HP</th>
  <th>Status</th>
  <th>Keterangan</th>
</tr>
</thead>
<tbody id="resultBody"></tbody>
</table>

<script>
console.log("SCRIPT READY");

document.getElementById("btnProses").addEventListener("click", processKMZ);

async function processKMZ() {
  document.getElementById("info").innerText = "Memproses KMZ...";
  console.log("PROSES DIKLIK");

  const surveiFile = document.getElementById("kmzSurvei").files[0];
  const designFile = document.getElementById("kmzDesign").files[0];

  if (!surveiFile || !designFile) {
    alert("KMZ SURVEI & DESIGN WAJIB DIISI");
    return;
  }

  const survei = await parseKMZ(surveiFile);
  const design = await parseKMZ(designFile);

  console.log("SURVEI POINT:", survei.length);
  console.log("DESIGN POINT:", design.length);

  const hasil = analyzeHP(survei, design);

  renderTable(hasil);

  document.getElementById("info").innerText =
    `Selesai — Total HP: ${hasil.length}`;
}

// ============================
// PARSE KMZ → POINT ONLY
// ============================
async function parseKMZ(file) {
  const zip = await JSZip.loadAsync(file);
  const kmlName = Object.keys(zip.files).find(f => f.endsWith(".kml"));

  if (!kmlName) {
    alert("KML tidak ditemukan di KMZ");
    return [];
  }

  const kmlText = await zip.files[kmlName].async("text");
  const xml = new DOMParser().parseFromString(kmlText, "text/xml");

  const placemarks = [...xml.getElementsByTagName("Placemark")];
  const data = [];

  placemarks.forEach(pm => {
    const point = pm.getElementsByTagName("Point")[0];
    if (!point) return;

    const coord = point.getElementsByTagName("coordinates")[0];
    if (!coord) return;

    const [lon, lat] = coord.textContent.trim().split(",").map(Number);
    if (isNaN(lat) || isNaN(lon)) return;

    const name =
      pm.getElementsByTagName("name")[0]?.textContent || "HP";

    data.push({
      id: name,
      lon,
      lat
    });
  });

  console.log("Parsed:", data.length);
  return data;
}

// ============================
// ANALYZE MATCH / TAKEOUT
// ============================
function analyzeHP(survei, design) {
  const MAX_DIST = 5; // meter

  return survei.map((hp, i) => {
    let matched = false;

    for (const d of design) {
      const p1 = turf.point([hp.lon, hp.lat]);
      const p2 = turf.point([d.lon, d.lat]);
      const dist = turf.distance(p1, p2, { units: "meters" });

      if (dist <= MAX_DIST) {
        matched = true;
        break;
      }
    }

    return {
      no: i + 1,
      id: hp.id,
      status: matched ? "MATCH" : "TAKEOUT",
      ket: matched ? "-" : "Tidak ada di design"
    };
  });
}

// ============================
// RENDER TABLE
// ============================
function renderTable(data) {
  const tbody = document.getElementById("resultBody");
  tbody.innerHTML = "";

  data.forEach(d => {
    const tr = document.createElement("tr");
    tr.className = d.status;

    tr.innerHTML = `
      <td>${d.no}</td>
      <td>${d.id}</td>
      <td>${d.status}</td>
      <td>${d.ket}</td>
    `;

    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>
