<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>HP MATCH vs TAKEOUT (HP ONLY - SAFE)</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 15px; }
th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
th { background: #eee; }
.MATCH { background: #c8f7c5; }
.TAKEOUT { background: #f7c5c5; }
</style>
</head>

<body>

<h2>HP MATCH vs TAKEOUT (FILTER HP ONLY)</h2>

<label>KMZ SURVEI</label><br>
<input type="file" id="kmzSurvei" accept=".kmz"><br><br>

<label>KMZ DESIGN</label><br>
<input type="file" id="kmzDesign" accept=".kmz"><br><br>

<button id="btnProses">PROSES</button>
<p id="info"></p>

<table>
<thead>
<tr>
  <th>No</th>
  <th>Nama HP</th>
  <th>Status</th>
  <th>Keterangan</th>
</tr>
</thead>
<tbody id="resultBody"></tbody>
</table>

<script>
document.getElementById("btnProses").addEventListener("click", processKMZ);

async function processKMZ() {
  const surveiFile = document.getElementById("kmzSurvei").files[0];
  const designFile = document.getElementById("kmzDesign").files[0];

  if (!surveiFile || !designFile) {
    alert("KMZ belum lengkap");
    return;
  }

  document.getElementById("info").innerText = "Memproses...";

  const survei = await parseKMZ_HP_SAFE(surveiFile);
  const design = await parseKMZ_HP_SAFE(designFile);

  console.log("HP SURVEI:", survei);
  console.log("HP DESIGN:", design);

  const hasil = analyzeHP(survei, design);
  renderTable(hasil);

  document.getElementById("info").innerText =
    `Selesai â€” HP Survei: ${survei.length}`;
}

// ===============================
// PARSE KMZ â€“ SUPER SAFE
// ===============================
async function parseKMZ_HP_SAFE(file) {
  const zip = await JSZip.loadAsync(file);
  const kmlName = Object.keys(zip.files).find(f => f.endsWith(".kml"));
  const kmlText = await zip.files[kmlName].async("text");
  const xml = new DOMParser().parseFromString(kmlText, "text/xml");

  const placemarks = [...xml.getElementsByTagName("Placemark")];
  const hpList = [];

  placemarks.forEach(pm => {
    // ðŸ”¥ Ambil SEMUA kemungkinan nama
    let textPool = "";

    const nameEl = pm.getElementsByTagName("name")[0];
    if (nameEl) textPool += " " + nameEl.textContent;

    pm.querySelectorAll("SimpleData").forEach(el => {
      textPool += " " + el.textContent;
    });

    pm.querySelectorAll("Data value").forEach(el => {
      textPool += " " + el.textContent;
    });

    const text = textPool.toUpperCase();

    // ðŸ”¥ FILTER HP
    const isHP =
      text.includes("HP") ||
      text.includes("HOME") ||
      text.includes("HOME-BIZ") ||
      text.includes("HOME BIZ") ||
      text.startsWith("NN") ||
      text.includes(" NN");

    if (!isHP) return;

    const point = pm.getElementsByTagName("Point")[0];
    if (!point) return;

    const coord = point.getElementsByTagName("coordinates")[0];
    if (!coord) return;

    const [lon, lat] = coord.textContent.trim().split(",").map(Number);
    if (isNaN(lat) || isNaN(lon)) return;

    hpList.push({
      id: textPool.trim() || "HP_TANPA_NAMA",
      lon,
      lat
    });
  });

  return hpList;
}

// ===============================
// MATCH / TAKEOUT
// ===============================
function analyzeHP(survei, design) {
  const MAX_DIST = 5; // meter

  return survei.map((hp, i) => {
    let match = false;

    for (const d of design) {
      const dist = turf.distance(
        turf.point([hp.lon, hp.lat]),
        turf.point([d.lon, d.lat]),
        { units: "meters" }
      );
      if (dist <= MAX_DIST) {
        match = true;
        break;
      }
    }

    return {
      no: i + 1,
      id: hp.id,
      status: match ? "MATCH" : "TAKEOUT",
      ket: match ? "-" : "Tidak ada di design"
    };
  });
}

// ===============================
// TABLE
// ===============================
function renderTable(data) {
  const tbody = document.getElementById("resultBody");
  tbody.innerHTML = "";

  data.forEach(d => {
    const tr = document.createElement("tr");
    tr.className = d.status;
    tr.innerHTML = `
      <td>${d.no}</td>
      <td>${d.id}</td>
      <td>${d.status}</td>
      <td>${d.ket}</td>
    `;
    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>
